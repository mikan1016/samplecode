<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>うまく試着できるかな？</title>

<style>
  body { font-family: sans-serif; text-align: center; }
  #gameArea {
    width: 100%;
    height: 500px;
    border: 2px solid #666;
    position: relative;
    overflow: hidden;
    background-size: cover;
    background-position: center;
  }

  #movingImage {
    position: absolute;
    width: 200px;
    height: 300px;
    object-fit: cover;
  }
</style>
</head>

<body>

<h2>うまく試着できるかな？</h2>

<!-- 背景画像アップロード -->
<p>背景画像を選ぶ：<input type="file" id="bgInput" accept="image/*"></p>

<!-- 動く画像選択 -->
<p>動く画像を選ぶ：</p>
<label><input type="radio" name="char" value="uniform1.png" checked> 画像1</label>
<label><input type="radio" name="char" value="uniform2.png"> 画像2</label>

<br><br>

<button id="start">動かす</button>
<button id="stop">止める</button>
<button id="download">ダウンロード</button>

<h3>最高得点：<span id="bestScore">0</span></h3>

<div id="gameArea">
  <img id="movingImage" src="uniform1.png">
</div>

<script>
let intervalId;
let bestScore = 0;

// 背景設定
document.getElementById("bgInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  document.getElementById("gameArea").style.backgroundImage = `url(${url})`;
});

// キャラ選択
document.querySelectorAll("input[name='char']").forEach(r => {
  r.addEventListener("change", () => {
    document.getElementById("movingImage").src = r.value;
  });
});

const gameArea = document.getElementById("gameArea");
const movingImage = document.getElementById("movingImage");

// ランダムに動かす
function startMoving() {
  clearInterval(intervalId);

  intervalId = setInterval(() => {
    const maxX = gameArea.clientWidth - movingImage.clientWidth;
    const maxY = gameArea.clientHeight - movingImage.clientHeight;

    const x = Math.random() * maxX;
    const y = Math.random() * maxY;

    movingImage.style.left = x + "px";
    movingImage.style.top = y + "px";
  }, 100);
}

// スコア計算：中心ほど高得点
function calculateScore() {
  const centerX = gameArea.clientWidth / 2;
  const centerY = gameArea.clientHeight / 2;

  const imgX = movingImage.offsetLeft + movingImage.clientWidth / 2;
  const imgY = movingImage.offsetTop + movingImage.clientHeight / 2;

  const dx = centerX - imgX;
  const dy = centerY - imgY;

  const distance = Math.sqrt(dx*dx + dy*dy);
  const maxDist = Math.sqrt(centerX*centerX + centerY*centerY);

  const score = Math.max(0, Math.round(1000 * (1 - distance / maxDist)));
  return score;
}

// 止める（得点処理のみ）
document.getElementById("stop").addEventListener("click", () => {
  clearInterval(intervalId);

  const score = calculateScore();
  if (score > bestScore) {
    bestScore = score;
    document.getElementById("bestScore").textContent = bestScore;
  }
});

// スクリーンショット生成 → ダウンロード
document.getElementById("download").addEventListener("click", () => {
  const canvas = document.createElement("canvas");
  canvas.width = gameArea.clientWidth;
  canvas.height = gameArea.clientHeight;

  const ctx = canvas.getContext("2d");

  // 背景取得
  const bgStyle = window.getComputedStyle(gameArea).backgroundImage;
  const bgUrl = bgStyle.slice(5, -2);

  const bgImg = new Image();
  bgImg.src = bgUrl;

  bgImg.onload = () => {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

    const img = new Image();
    img.src = movingImage.src;

    img.onload = () => {
      ctx.drawImage(
        img,
        movingImage.offsetLeft,
        movingImage.offsetTop,
        movingImage.clientWidth,
        movingImage.clientHeight
      );

      const link = document.createElement("a");
      link.download = "result.png";
      link.href = canvas.toDataURL();
      link.click();
    };
  };
});

// ボタン
document.getElementById("start").addEventListener("click", startMoving);
</script>

</body>
</html>


