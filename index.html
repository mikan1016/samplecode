<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>うまく試着できるかな？（ゲーム）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","メイリオ",sans-serif;margin:12px;}
  header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  h1{font-size:1.2rem;margin:0}
  #gameArea{width:100%;height:60vh;border:2px solid #999;position:relative;overflow:hidden;background-size:cover;background-position:center;margin-top:10px}
  #movingImage{position:absolute;width:200px;height:300px;object-fit:cover;pointer-events:none}
  .controls{margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button{padding:8px 12px;font-size:1rem;border-radius:8px}
  #snsArea button{padding:6px 10px}
  @media(min-width:900px){ #gameArea{height:70vh} }
</style>
</head>
<body>

<header>
  <h1>うまく試着できるかな？</h1>
  <nav>
    <a href="free-move.html">自由移動ページへ</a>
  </nav>
</header>

<section class="controls">
  <label>背景画像：
    <input id="bgInput" type="file" accept="image/*">
  </label>

  <div>
    動く画像：
    <label><input type="radio" name="char" value="uniform1.png" checked> 画像1</label>
    <label><input type="radio" name="char" value="uniform2.png"> 画像2</label>
  </div>

  <button id="start">動かす</button>
  <button id="stop">止める</button>
  <button id="download">ダウンロード</button>
  <button id="makeThumb">サムネイル生成</button>

  <div style="margin-left:12px;">
    最高得点：<strong id="bestScore">0</strong>
  </div>
</section>

<section id="snsArea" style="margin-top:6px">
  <span>SNS共有：</span>
  <button id="shareX">X</button>
  <button id="shareLINE">LINE</button>
  <button id="shareInsta">Instagram</button>
</section>

<div id="gameArea">
  <img id="movingImage" src="uniform1.png" alt="moving">
</div>

<!-- Thumbnail preview -->
<div style="margin-top:10px;">
  <p>生成されたサムネイル（プレビュー）</p>
  <img id="thumbPreview" style="width:180px;height:180px;object-fit:cover;border:1px solid #ccc;">
  <a id="thumbSave" style="display:inline-block;margin-left:8px;padding:8px 10px;background:#2b7cff;color:#fff;border-radius:6px;text-decoration:none">ダウンロード</a>
</div>

<script>
/* ---------- 設定 ---------- */
const gameArea = document.getElementById('gameArea');
const movingImage = document.getElementById('movingImage');
const bgInput = document.getElementById('bgInput');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const downloadBtn = document.getElementById('download');
const makeThumbBtn = document.getElementById('makeThumb');
const thumbPreview = document.getElementById('thumbPreview');
const thumbSave = document.getElementById('thumbSave');
const bestScoreEl = document.getElementById('bestScore');

let intervalId = null;
let bestScore = 0;
let currentScore = 0;
const imgW = 200, imgH = 300;
let lastLeft = 0, lastTop = 0;

/* 背景アップロード（dataURLで保持） */
let bgDataUrl = null;
bgInput.addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ev => {
    bgDataUrl = ev.target.result;
    gameArea.style.backgroundImage = `url(${bgDataUrl})`;
  };
  r.readAsDataURL(f);
});

/* キャラ選択 */
document.querySelectorAll("input[name='char']").forEach(r=>{
  r.addEventListener('change', ()=>{
    movingImage.src = r.value;
  });
});

/* 中心バイアス移動：25%の確率で中心近傍に行く */
function computeNextPos() {
  const areaW = gameArea.clientWidth;
  const areaH = gameArea.clientHeight;
  // 25% で中心近傍
  if(Math.random() < 0.25) {
    // 範囲：中心 ± (area * 0.12) を狙う
    const cx = areaW/2 + (Math.random()*2-1) * areaW*0.12;
    const cy = areaH/2 + (Math.random()*2-1) * areaH*0.12;
    const left = Math.max(0, Math.min(areaW - imgW, cx - imgW/2));
    const top  = Math.max(0, Math.min(areaH - imgH, cy - imgH/2));
    return {left, top};
  } else {
    // 完全ランダム
    const left = Math.random() * Math.max(0, areaW - imgW);
    const top  = Math.random() * Math.max(0, areaH - imgH);
    return {left, top};
  }
}

/* 動かす */
function startMoving(){
  clearInterval(intervalId);
  intervalId = setInterval(()=>{
    const pos = computeNextPos();
    movingImage.style.left = pos.left + 'px';
    movingImage.style.top  = pos.top + 'px';
    lastLeft = pos.left; lastTop = pos.top;
  }, 350); // 350ms ごとに位置変化
}

/* 停止・得点計算（中心に近いほど高得点） */
function calculateScoreAtCurrent() {
  const areaCenterX = gameArea.clientWidth/2;
  const areaCenterY = gameArea.clientHeight/2;

  const imgCenterX = lastLeft + imgW/2;
  const imgCenterY = lastTop + imgH/2;

  const dx = areaCenterX - imgCenterX;
  const dy = areaCenterY - imgCenterY;
  const dist = Math.sqrt(dx*dx + dy*dy);

  const maxDist = Math.sqrt((areaCenterX)**2 + (areaCenterY)**2);
  const score = Math.max(0, Math.round(1000 * (1 - dist/maxDist)));
  return score;
}

startBtn.addEventListener('click', ()=> {
  startMoving();
});

stopBtn.addEventListener('click', ()=>{
  clearInterval(intervalId);
  // Ensure lastLeft/Top are set based on actual position
  if(movingImage.style.left) lastLeft = parseFloat(movingImage.style.left);
  if(movingImage.style.top) lastTop = parseFloat(movingImage.style.top);
  currentScore = calculateScoreAtCurrent();
  if(currentScore > bestScore){ bestScore = currentScore; bestScoreEl.textContent = bestScore; }
  alert('今回の得点：' + currentScore + '　最高得点：' + bestScore);
});

/* ダウンロード（canvas合成） */
downloadBtn.addEventListener('click', async ()=>{
  // create canvas sized to gameArea
  const w = gameArea.clientWidth, h = gameArea.clientHeight;
  const c = document.createElement('canvas'); c.width = w; c.height = h;
  const ctx = c.getContext('2d');

  // bg
  if(bgDataUrl){
    await drawImageFromSrc(ctx, bgDataUrl, 0,0,w,h);
  } else {
    // neutral bg
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
  }

  // moving image
  const src = movingImage.src;
  const left = lastLeft || parseFloat(movingImage.style.left) || 0;
  const top  = lastTop  || parseFloat(movingImage.style.top) || 0;
  await drawImageFromSrc(ctx, src, left, top, imgW, imgH);

  // download
  const link = document.createElement('a');
  link.href = c.toDataURL('image/png');
  link.download = 'result.png';
  link.click();
});

/* サムネイル生成（600x600）：背景ぼかし + 制服中央 + タイトルテキスト */
makeThumbBtn.addEventListener('click', async ()=>{
  const size = 600;
  const c = document.createElement('canvas'); c.width = size; c.height = size;
  const ctx = c.getContext('2d');

  // 背景（blur）: draw bg scaled & apply simple box blur via temporary canvas (approx)
  if(bgDataUrl){
    // draw bg scaled to canvas
    await drawImageFromSrc(ctx, bgDataUrl, 0,0,size,size);
    // apply CSS blur via filter for simplicity if available
    // We'll use an offscreen canvas and ctx.filter
    try{
      const off = document.createElement('canvas'); off.width=size; off.height=size;
      const offCtx = off.getContext('2d');
      offCtx.filter = 'blur(12px)';
      const bg = new Image(); bg.src = bgDataUrl;
      await new Promise(r=>{ bg.onload=r; });
      offCtx.drawImage(bg,0,0,size,size);
      ctx.clearRect(0,0,size,size);
      ctx.drawImage(off,0,0,size,size);
    }catch(e){
      // fallback: leave as-is
    }
  } else {
    ctx.fillStyle = '#f2f2f2'; ctx.fillRect(0,0,size,size);
  }

  // overlay semi-transparent dark layer for contrast
  ctx.fillStyle = 'rgba(0,0,0,0.25)'; ctx.fillRect(0,0,size,size);

  // draw moving image centered with scale to fit nicely
  const img = new Image(); img.src = movingImage.src;
  await new Promise(r=>{ img.onload=r; });
  // scale to about 60% of thumbnail width
  const targetW = size * 0.6;
  const targetH = targetW * (imgH/imgW);
  const x = (size - targetW)/2;
  const y = (size - targetH)/2 - 20;
  ctx.drawImage(img, x, y, targetW, targetH);

  // Title text at bottom
  ctx.font = 'bold 36px sans-serif';
  ctx.textAlign = 'center';
  ctx.fillStyle = 'white';
  ctx.fillText('うまく試着できるかな？', size/2, size - 36);
  // stroke for readability
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgba(0,0,0,0.6)';
  ctx.strokeText('うまく試着できるかな？', size/2, size - 36);

  const dataUrl = c.toDataURL('image/png');
  thumbPreview.src = dataUrl;
  thumbSave.href = dataUrl;
  thumbSave.download = 'thumbnail.png';
});

/* helper to draw image from src (dataURL or same-origin) returning Promise */
function drawImageFromSrc(ctx, src, x,y,w,h){
  return new Promise((resolve,reject)=>{
    const i = new Image();
    // try to avoid tainting: if src is data url or same-origin it's fine
    i.crossOrigin = 'anonymous';
    i.onload = ()=>{ ctx.drawImage(i,x,y,w,h); resolve(); };
    i.onerror = ()=>{ resolve(); }; // don't fail overall
    i.src = src;
  });
}

/* SNS buttons */
document.getElementById('shareX').addEventListener('click', ()=>{
  const text = encodeURIComponent(`うまく試着できるかな？ 最高得点: ${bestScore}点`);
  const url  = encodeURIComponent(location.href);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
});
document.getElementById('shareLINE').addEventListener('click', ()=>{
  const text = encodeURIComponent(`うまく試着できるかな？ 最高得点: ${bestScore}点\n${location.href}`);
  window.open(`https://line.me/R/msg/text/?${text}`, '_blank');
});
document.getElementById('shareInsta').addEventListener('click', ()=>{
  alert('Instagramはアプリに画像をアップする操作が必要です。まずは「サムネイル生成」→画像を保存して、Instagramで投稿してください。');
  // try to open instagram app:
  location.href = 'instagram://app';
});

/* init: center moving image */
window.addEventListener('load', ()=>{
  const aw = gameArea.clientWidth, ah = gameArea.clientHeight;
  const left = Math.max(0, (aw - imgW)/2);
  const top  = Math.max(0, (ah - imgH)/2);
  movingImage.style.left = left + 'px';
  movingImage.style.top  = top  + 'px';
  lastLeft = left; lastTop = top;
});
</script>
</body>
</html>
