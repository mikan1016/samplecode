<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>うまく試着できるかな？</title>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    margin: 0;
    padding: 10px;
  }

  h2 {
    font-size: 1.4rem;
    margin-bottom: 10px;
  }

  #gameArea {
    width: 100%;
    height: 60vh;
    border: 2px solid #666;
    position: relative;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    margin-top: 10px;
  }

  #movingImage {
    position: absolute;
    width: 200px;
    height: 300px;
    object-fit: cover;
  }

  button {
    padding: 10px 15px;
    font-size: 1.0rem;
    margin: 5px;
  }

  #snsArea button {
    background: #f0f0f0;
    border-radius: 6px;
    padding: 8px 12px;
  }

  #snsArea {
    margin-top: 10px;
  }
</style>
</head>

<body>

<h2>うまく試着できるかな？</h2>

<!-- 背景画像アップロード -->
<p>背景画像を選ぶ：<br>
  <input type="file" id="bgInput" accept="image/*">
</p>

<!-- 動く画像選択 -->
<p>動く画像を選ぶ：</p>
<label><input type="radio" name="char" value="uniform1.png" checked> 画像1</label>
<label><input type="radio" name="char" value="uniform2.png"> 画像2</label>

<br><br>

<button id="start">動かす</button>
<button id="stop">止める</button>
<button id="download">ダウンロード</button>

<h3>最高得点：<span id="bestScore">0</span></h3>

<div id="snsArea">
  <p>SNSでシェア：</p>
  <button id="shareX">X（Twitter）</button>
  <button id="shareLINE">LINE</button>
  <button id="shareInsta">Instagram</button>
</div>

<div id="gameArea">
  <img id="movingImage" src="uniform1.png">
</div>

<script>
let intervalId;
let bestScore = 0;

// 背景設定
document.getElementById("bgInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const url = URL.createObjectURL(file);
  document.getElementById("gameArea").style.backgroundImage = `url(${url})`;
});

// キャラ選択
document.querySelectorAll("input[name='char']").forEach(r => {
  r.addEventListener("change", () => {
    document.getElementById("movingImage").src = r.value;
  });
});

const gameArea = document.getElementById("gameArea");
const movingImage = document.getElementById("movingImage");

// ランダムに動かす
function startMoving() {
  clearInterval(intervalId);

  intervalId = setInterval(() => {
    const maxX = gameArea.clientWidth - movingImage.clientWidth;
    const maxY = gameArea.clientHeight - movingImage.clientHeight;

    const x = Math.random() * Math.max(0, maxX);
    const y = Math.random() * Math.max(0, maxY);

    movingImage.style.left = x + "px";
    movingImage.style.top = y + "px";
  }, 120);
}

// スコア計算
function calculateScore() {
  const centerX = gameArea.clientWidth / 2;
  const centerY = gameArea.clientHeight / 2;

  const imgX = movingImage.offsetLeft + movingImage.clientWidth / 2;
  const imgY = movingImage.offsetTop + movingImage.clientHeight / 2;

  const dx = centerX - imgX;
  const dy = centerY - imgY;

  const distance = Math.sqrt(dx*dx + dy*dy);
  const maxDist = Math.sqrt(centerX*centerX + centerY*centerY);

  const score = Math.max(0, Math.round(1000 * (1 - distance / maxDist)));
  return score;
}

// 止める
document.getElementById("stop").addEventListener("click", () => {
  clearInterval(intervalId);

  const score = calculateScore();
  if (score > bestScore) {
    bestScore = score;
    document.getElementById("bestScore").textContent = bestScore;
  }
});

// ダウンロード
document.getElementById("download").addEventListener("click", () => {
  const canvas = document.createElement("canvas");
  canvas.width = gameArea.clientWidth;
  canvas.height = gameArea.clientHeight;

  const ctx = canvas.getContext("2d");

  // 背景読み込み
  const bgStyle = window.getComputedStyle(gameArea).backgroundImage;
  const bgUrl = bgStyle.slice(5, -2);

  const bgImg = new Image();
  bgImg.src = bgUrl;

  bgImg.onload = () => {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

    const img = new Image();
    img.src = movingImage.src;

    img.onload = () => {
      ctx.drawImage(
        img,
        movingImage.offsetLeft,
        movingImage.offsetTop,
        movingImage.clientWidth,
        movingImage.clientHeight
      );

      const link = document.createElement("a");
      link.download = "result.png";
      link.href = canvas.toDataURL();
      link.click();
    };
  };
});


// ▼▼ SNS 共有機能 ▼▼

// X（Twitter）
document.getElementById("shareX").addEventListener("click", () => {
  const text = encodeURIComponent(`【うまく試着できるかな？】\n最高得点：${bestScore} 点！\nあなたも挑戦してみてね！`);
  const url = encodeURIComponent(window.location.href);
  window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`);
});

// LINE
document.getElementById("shareLINE").addEventListener("click", () => {
  const text = encodeURIComponent(`最高得点：${bestScore} 点！\n「うまく試着できるかな？」で遊んでみてね！\n${window.location.href}`);
  window.open(`https://line.me/R/msg/text/?${text}`);
});

// Instagram（投稿API不可 → アプリ誘導）
document.getElementById("shareInsta").addEventListener("click", () => {
  alert("画像を保存した後、Instagramで投稿してね！");
  window.open("instagram://app");  // Instagramアプリを開く
});

// スタート
document.getElementById("start").addEventListener("click", startMoving);
</script>

</body>
</html>
